<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>duf-monitor â€” Disk Usage Dashboard</title>
<style>
  :root {
    --bg: #0c0f14; --bg2: #151921; --bg3: #1e2330; --border: #2a2f3d;
    --text: #e2e5eb; --text2: #8e95a5; --text3: #5c6372;
    --green: #22c55e; --green-dim: rgba(34,197,94,0.12);
    --yellow: #eab308; --yellow-dim: rgba(234,179,8,0.12);
    --orange: #f97316; --orange-dim: rgba(249,115,22,0.12);
    --red: #ef4444; --red-dim: rgba(239,68,68,0.12);
    --blue: #3b82f6; --blue-dim: rgba(59,130,246,0.12);
    --purple: #a855f7;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); }
  .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
  header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 16px 0; }
  .header-inner { display: flex; align-items: center; justify-content: space-between; }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon { width: 36px; height: 36px; background: var(--blue-dim); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  .logo h1 { font-size: 20px; font-weight: 700; }
  .logo h1 span { color: var(--blue); }
  .hostname-badge { padding: 4px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; font-size: 12px; color: var(--text2); font-family: monospace; }
  .header-info { display: flex; align-items: center; gap: 12px; font-size: 12px; color: var(--text3); }

  /* Stats */
  .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 24px 0; }
  .stat-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .stat-card .label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
  .stat-card .value { font-size: 28px; font-weight: 700; }
  .stat-card .sub { font-size: 12px; color: var(--text3); margin-top: 4px; }

  /* Disk cards */
  .disks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 16px; padding-bottom: 40px; }
  .disk-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: border-color 0.2s; }
  .disk-card:hover { border-color: var(--blue); }
  .disk-card.alert { border-color: var(--red); }
  .disk-card.warning { border-color: var(--yellow); }
  .disk-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
  .disk-mount { font-size: 18px; font-weight: 700; font-family: monospace; }
  .disk-device { font-size: 12px; color: var(--text3); margin-top: 2px; }
  .disk-percent { font-size: 32px; font-weight: 800; line-height: 1; }
  .disk-percent.green { color: var(--green); }
  .disk-percent.yellow { color: var(--yellow); }
  .disk-percent.orange { color: var(--orange); }
  .disk-percent.red { color: var(--red); }

  /* Progress bar */
  .progress-track { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; margin: 12px 0; }
  .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
  .progress-fill.green { background: var(--green); }
  .progress-fill.yellow { background: var(--yellow); }
  .progress-fill.orange { background: var(--orange); }
  .progress-fill.red { background: var(--red); }

  /* Disk details */
  .disk-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
  .disk-detail { text-align: center; padding: 8px; background: var(--bg); border-radius: 6px; }
  .disk-detail .val { font-size: 16px; font-weight: 700; }
  .disk-detail .lbl { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }

  /* Mini chart */
  .mini-chart { height: 40px; display: flex; align-items: flex-end; gap: 1px; margin-top: 12px; }
  .mini-bar { flex: 1; border-radius: 2px 2px 0 0; min-height: 2px; transition: height 0.3s; }

  /* Alerts banner */
  .alerts-banner { background: var(--red-dim); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; padding: 12px 20px; margin-bottom: 16px; display: none; }
  .alerts-banner.active { display: flex; align-items: center; gap: 12px; }
  .alerts-banner .icon { font-size: 20px; }
  .alerts-banner .msg { font-size: 14px; color: var(--red); font-weight: 600; }

  @media (max-width: 900px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .disks-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="container header-inner">
    <div class="logo">
      <div class="logo-icon">&#128190;</div>
      <h1>duf<span>-monitor</span></h1>
      <span class="hostname-badge" id="hostname">loading...</span>
    </div>
    <div class="header-info">
      <span>Polling every <strong id="pollInterval">-</strong>s</span>
      <span>|</span>
      <span>Alert at <strong id="alertThreshold">-</strong>%</span>
      <span>|</span>
      <span id="lastUpdate">-</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="alerts-banner" id="alertsBanner">
    <span class="icon">&#9888;</span>
    <span class="msg" id="alertsMsg"></span>
  </div>

  <div class="stats-row">
    <div class="stat-card">
      <div class="label">Total Disks</div>
      <div class="value" id="statDisks">-</div>
    </div>
    <div class="stat-card">
      <div class="label">Total Space</div>
      <div class="value" id="statTotal">-</div>
    </div>
    <div class="stat-card">
      <div class="label">Used Space</div>
      <div class="value" id="statUsed">-</div>
      <div class="sub" id="statUsedPct">-</div>
    </div>
    <div class="stat-card">
      <div class="label">Free Space</div>
      <div class="value" id="statFree">-</div>
      <div class="sub" id="statFreePct">-</div>
    </div>
  </div>

  <div class="disks-grid" id="disksGrid">
    <div style="text-align: center; color: var(--text3); padding: 60px;">Loading disk data...</div>
  </div>
</div>

<script>
  let ws = null;

  function formatBytes(bytes) {
    const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
    let i = 0;
    let b = bytes;
    while (Math.abs(b) >= 1024 && i < units.length - 1) { b /= 1024; i++; }
    return b.toFixed(1) + ' ' + units[i];
  }

  function pctColor(pct) {
    if (pct >= 90) return 'red';
    if (pct >= 75) return 'orange';
    if (pct >= 60) return 'yellow';
    return 'green';
  }

  async function loadData() {
    try {
      const res = await fetch('/api/current');
      const data = await res.json();
      renderData(data);
    } catch (e) {
      console.error('Load error:', e);
    }
  }

  function renderData(data) {
    const disks = data.disks || [];
    document.getElementById('hostname').textContent = data.hostname;
    document.getElementById('alertThreshold').textContent = data.alert_threshold;
    document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();

    // Stats
    let totalSpace = 0, usedSpace = 0, freeSpace = 0;
    disks.forEach(d => { totalSpace += d.total_bytes; usedSpace += d.used_bytes; freeSpace += d.free_bytes; });
    const overallPct = totalSpace > 0 ? (usedSpace / totalSpace * 100).toFixed(1) : 0;

    document.getElementById('statDisks').textContent = disks.length;
    document.getElementById('statTotal').textContent = formatBytes(totalSpace);
    document.getElementById('statUsed').textContent = formatBytes(usedSpace);
    document.getElementById('statUsedPct').textContent = overallPct + '% used';
    document.getElementById('statFree').textContent = formatBytes(freeSpace);
    document.getElementById('statFreePct').textContent = (100 - overallPct).toFixed(1) + '% free';

    // Alerts
    const alerts = disks.filter(d => d.usage_percent >= data.alert_threshold);
    const banner = document.getElementById('alertsBanner');
    if (alerts.length > 0) {
      banner.classList.add('active');
      document.getElementById('alertsMsg').textContent =
        `${alerts.length} disk${alerts.length > 1 ? 's' : ''} above ${data.alert_threshold}% threshold: ` +
        alerts.map(a => `${a.mountpoint} (${a.usage_percent}%)`).join(', ');
    } else {
      banner.classList.remove('active');
    }

    // Render disk cards
    const grid = document.getElementById('disksGrid');
    grid.innerHTML = disks.sort((a, b) => b.usage_percent - a.usage_percent).map(d => {
      const color = pctColor(d.usage_percent);
      const alertClass = d.usage_percent >= 90 ? 'alert' : d.usage_percent >= 75 ? 'warning' : '';
      return `
        <div class="disk-card ${alertClass}" onclick="showHistory('${encodeURIComponent(d.mountpoint)}')">
          <div class="disk-header">
            <div>
              <div class="disk-mount">${escapeHtml(d.mountpoint)}</div>
              <div class="disk-device">${escapeHtml(d.device)} &bull; ${escapeHtml(d.fstype)}</div>
            </div>
            <div class="disk-percent ${color}">${d.usage_percent}%</div>
          </div>
          <div class="progress-track">
            <div class="progress-fill ${color}" style="width: ${d.usage_percent}%"></div>
          </div>
          <div class="disk-details">
            <div class="disk-detail">
              <div class="val">${formatBytes(d.used_bytes)}</div>
              <div class="lbl">Used</div>
            </div>
            <div class="disk-detail">
              <div class="val">${formatBytes(d.free_bytes)}</div>
              <div class="lbl">Free</div>
            </div>
            <div class="disk-detail">
              <div class="val">${formatBytes(d.total_bytes)}</div>
              <div class="lbl">Total</div>
            </div>
          </div>
          <div class="mini-chart" id="chart-${CSS.escape(d.mountpoint)}"></div>
        </div>
      `;
    }).join('');

    // Load history charts for each disk
    disks.forEach(d => loadMiniChart(d.mountpoint));
  }

  async function loadMiniChart(mountpoint) {
    try {
      const res = await fetch(`/api/history/${encodeURIComponent(mountpoint)}?hours=24`);
      const data = await res.json();
      const chart = document.getElementById('chart-' + CSS.escape(mountpoint));
      if (!chart || !data.data.length) return;

      const maxPct = 100;
      // Sample to max 48 bars
      const points = data.data;
      const step = Math.max(1, Math.floor(points.length / 48));
      const sampled = points.filter((_, i) => i % step === 0);

      chart.innerHTML = sampled.map(p => {
        const h = Math.max(2, (p.usage_percent / maxPct) * 36);
        const c = pctColor(p.usage_percent);
        return `<div class="mini-bar" style="height: ${h}px; background: var(--${c});"></div>`;
      }).join('');
    } catch (e) { /* ignore */ }
  }

  async function showHistory(mountpoint) {
    // Future: expandable detail panel with full history graph
    console.log('History for', decodeURIComponent(mountpoint));
  }

  function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
  }

  // WebSocket for real-time updates
  function connectWS() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws`);
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'update') {
        renderData({ ...data, hostname: document.getElementById('hostname').textContent, alert_threshold: parseInt(document.getElementById('alertThreshold').textContent) || 90 });
      }
    };
    ws.onclose = () => { setTimeout(connectWS, 5000); };
    ws.onerror = () => { ws.close(); };
  }

  loadData();
  connectWS();
  // Also poll as fallback
  setInterval(loadData, 60000);
</script>
</body>
</html>
